<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Individual</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>

<body>
  <div class="dashboard new-dashboard individual-dashboard">
    <aside class="sidebar individual-dashboard__sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand u-flex-column-center">
          <img src="images/memora-logo.png" alt="Memora Logo" class="sidebar-logo">
          <span class="sidebar-name" id="sidebarUserName" data-user-name>User Name</span>
        </div>
      </div>
      <div class="sidebar-welcome">
        <span class="sidebar-welcome__line"></span>
        <span class="sidebar-welcome__text" data-i18n-key="dashboard_welcome_message">Welcome to your Dashboard</span>
        <span class="sidebar-welcome__line"></span>
      </div>
      <nav class="sidebar-nav individual-dashboard__menu">
        <a href="individual-dashboard.html" class="sidebar-link" data-i18n-key="sidebar_dashboard">Dashboard</a>
        <div class="has-submenu">
          <button class="submenu-toggle" type="button">
            <span data-i18n-key="menu_my_account">My Account</span>
            <span class="submenu-arrow"></span>
          </button>
          <ul class="submenu">
            <li><a href="my-profile.html" data-i18n-key="menu_my_profile">My Profile</a></li>
            <li><a href="manage-my-plan.html" data-i18n-key="menu_manage_my_plan">Manage My Plan</a></li>
            <li><a href="payments.html" data-i18n-key="menu_payments">Payments</a></li>
          </ul>
        </div>
        <a href="protected-members-individual.html" class="sidebar-link" data-i18n-key="menu_protected_members">Protected Members</a>
        <a href="settings.html" class="sidebar-link" data-i18n-key="menu_settings">Settings</a>
        <a href="help.html" class="sidebar-link" data-i18n-key="sidebar_help">Help</a>
      </nav>
      <div class="sidebar-footer">
        <button class="sidebar-logout logout" data-i18n-key="logout_button">Log Out</button>
        <div class="sidebar-languages">
          <button class="lang-btn" data-lang="en" data-i18n-key="lang_english">English</button>
          <button class="lang-btn" data-lang="es" data-i18n-key="lang_spanish">Español</button>
        </div>
        <div class="sidebar-footer-legal">
          <span class="footer-line"></span>
          <span class="footer-text">©2025 MemoraCare | Privacy Policy</span>
          <span class="footer-line"></span>
        </div>
      </div>
    </aside>

    <main class="main-content individual-dashboard__main">
      <div class="main-card">
        <header class="main-card__header">
          <h1>
            <span data-i18n-key="welcome_back">Welcome back, </span>
            <span id="userName"><strong data-user-name>User Name</strong></span>
          </h1>
        </header>
        <div class="main-card__metrics">
          <div class="metric-item">
            <span class="metric-item__label" data-i18n-key="plan_status_label">Your Plan Status</span>
            <span class="status-pill status-pill--active" data-i18n-key="plan_status_pill_active">ACTIVE</span>
          </div>
          <div class="metric-item">
            <span class="metric-item__label" data-i18n-key="total_coverage_label">Your Coverage</span>
            <span class="status-pill status-pill--coverage" data-i18n-key="total_coverage_pill">UP TO $15,000</span>
          </div>
          <div class="metric-item">
            <span class="metric-item__label" data-i18n-key="next_payment_label">Next Payment</span>
            <span class="status-pill status-pill--payment" data-i18n-key="next_payment_pill">$49.99 DUE SEP 15,
              2025</span>
          </div>
        </div>
        <div class="main-card__actions">
          <a href="my-profile.html" class="button primary-button" data-i18n-key="update_profile_button">Update My Profile</a>
          <a href="manage-my-plan.html" class="button primary-button" data-i18n-key="manage_plan_button">Manage My Plan</a>
          <a href="protected-members-individual.html" class="button primary-button" data-i18n-key="add_family_member_button">Add a family member</a>
          <a href="settings.html" class="button primary-button" data-i18n-key="manage_alerts_button">Manage Alerts</a>
        </div>
      </div>
      <section class="individual-banner">
        <div class="individual-banner__content">
          <h2 data-i18n-key="promo_text_title">Human-centered benefits for your team.</h2>
          <p>Offer your employees reliable and affordable funeral protection. A
            practical solution to enhance your company's benefit offering and support your team when they need it most.
          </p>
        </div>
        <div class="banner-nav">
          <button class="banner-nav__arrow">←</button>
          <button class="banner-nav__arrow">→</button>
        </div>
      </section>
    </main>
  </div>
  <script src="i18n.js"></script>
  <script src="app.js"></script>
  <script>
  const API_USER_ME = '/wp-json/wp/v2/users/me';

  function loadCurrentUser() {
    const token = sessionStorage.getItem('memora_token');

    if (!token) {
        console.warn('No token found, redirecting to login');
        window.location.href = 'individual-login.html';
        return;
    }

    fetch(API_USER_ME, {
        headers: {
            'Authorization': 'Bearer ' + token
        }
    })
    .then(res => {
        if (!res.ok) throw new Error('Error: ' + res.status);
        return res.json();
    })
    .then(user => {
        // display_name viene en "name"
        const fullName = user.name || '';

// Seleccionar el <strong> dentro de #userName y el div de la barra lateral
const nameEl = document.querySelector('#userName strong');
const sidebarNameEl = document.querySelector('#sidebarUserName');

// Asignar el nombre del usuario si existen los elementos
if (nameEl) {
  nameEl.textContent = fullName;
}
if (sidebarNameEl) {
  sidebarNameEl.textContent = fullName;
}

    })
    .catch(err => console.error(err));
  }

  document.addEventListener('DOMContentLoaded', loadCurrentUser);
  </script>


<script>
document.addEventListener('DOMContentLoaded', async () => {
  console.log('[Memora] script cargó'); // debug
  const API_BASE = '/wp-json';
  const $  = (s, c=document) => c.querySelector(s);
  const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));

  function titleCaseEmail(email){
    if(!email) return 'Usuario';
    const base = email.split('@')[0].replace(/[._-]+/g,' ');
    return base.split(' ').map(w=> w? w[0].toUpperCase()+w.slice(1) : '').join(' ');
  }
  function formatDateISO(iso){
    if(!iso) return '-';
    const d = new Date(iso);
    return isNaN(d) ? '-' : d.toLocaleDateString('es-AR',{day:'2-digit',month:'short',year:'numeric'}).replace('.', '');
  }
  function planUI(plan){
    const p = (plan||'').toLowerCase();
    if (p==='bussines'||p==='business'||p==='corporate') return {badge:'Miembro empresarial', plan:'Corporate', dest:'/business-dashboard.html'};
    if (p==='personal'||p==='individual'||p==='familiar') return {badge:'Miembro individual', plan:'Individual / Familiar', dest:'/individual-dashboard.html'};
    return {badge:'Sin membresía', plan:'—', dest:'/'};
  }
  function statusUI(s){
    const x = (s||'').toLowerCase();
    if (x==='active'||x==='wc-active') return {label:'Activo', ok:true};
    if (x==='on-hold'||x==='pending') return {label:'En pausa', ok:false};
    if (x==='cancelled'||x==='expired') return {label:'Inactivo', ok:false};
    return {label:'Desconocido', ok:false};
  }

  const token = sessionStorage.getItem('memora_token');
  if(!token){ console.warn('[Memora] no hay token, voy a login'); location.href='/individual-login.html'; return; }

  let me = null;
  try { me = JSON.parse(sessionStorage.getItem('memora_user')||'null'); } catch(_){}
  try {
    const r = await fetch(`${API_BASE}/memora/v1/me`, { headers:{ Authorization: 'Bearer '+token }});
    console.log('[Memora] /me status =', r.status);
    if(r.ok){ me = await r.json(); sessionStorage.setItem('memora_user', JSON.stringify(me)); }
    else if (!me) { throw new Error('No autenticado'); }
  } catch(e){
    console.warn('[Memora] no pude traer /me', e);
    if(!me){ location.href='/individual-login.html'; return; }
  }

  console.log('[Memora] me =', me); // ▶️ deberías ver email/plan/status

  const displayName = me.display || me.name || titleCaseEmail(me.email);

  // Pintar nombre (targets típicos + data-user-name)
  const nameTargets = [
  '#userName strong',    // selecciona el <strong> en el encabezado
  '#sidebarUserName',    // selecciona el nombre en la barra lateral
  '[data-user-name]',
  '.individual-dashboard__profile-name',
  '.profile-name',
  '#user-name',
  '.user-name'
];

  for(const sel of nameTargets){ $$(sel).forEach(el=>{ el.textContent = displayName; }); }

  // Plan/estado
  const p = planUI(me.plan);
  const s = statusUI(me.status);
  const eyebrow = $('.individual-dashboard__profile-eyebrow');
  if(eyebrow) eyebrow.textContent = p.badge;
  const planNameEl = $('.individual-dashboard__plan-name');
  if(planNameEl) planNameEl.textContent = p.plan;
  const planStatusEl = $('.individual-dashboard__plan-status');
  if(planStatusEl) planStatusEl.textContent = s.label;

  const metricStatus = $('.metric-card .metric-card__value');
  if(metricStatus){
    metricStatus.textContent = s.label;
    metricStatus.classList.toggle('metric-card__value--success', !!s.ok);
  }

  const nextPayEls = $$('.individual-dashboard .metric-card:nth-child(3) .metric-card__value, .individual-dashboard__plan-list dd:nth-of-type(2)');
  nextPayEls.forEach(el => el.textContent = formatDateISO(me.expires_at));

  const logoutBtn = document.querySelector('.logout');
  if (logoutBtn) logoutBtn.addEventListener('click', ()=>{
    sessionStorage.removeItem('memora_token');
    sessionStorage.removeItem('memora_user');
    location.href='/individual-login.html';
  });
});
</script>

</body>
</html>


