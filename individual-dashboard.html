<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Individual</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  <div class="individual-dashboard">
    <aside class="sidebar individual-dashboard__sidebar updated-panel">
      <div class="individual-dashboard__icon" aria-hidden="true"></div>
      <div class="individual-dashboard__profile-card">
        <div class="individual-dashboard__profile-name" id="sidebarUserName">Maria Thompson</div>
      </div>
      <p class="individual-dashboard__welcome">Welcome to your Dashboard</p>

      <nav class="individual-dashboard__menu" aria-label="Sidebar">
        <a class="individual-dashboard__link" href="my-profile.html">My Account <span aria-hidden="true">›</span></a>
        <a class="individual-dashboard__link" href="payments.html">Payments <span aria-hidden="true">›</span></a>
        <a class="individual-dashboard__link" href="help.html">Help <span aria-hidden="true">›</span></a>
        <a class="individual-dashboard__link" href="settings.html">Settings <span aria-hidden="true">›</span></a>
      </nav>

      <div class="individual-dashboard__sidebar-footer">
        <button class="logout" type="button">Log Out</button>
        <div class="individual-sidebar__language">
          <button class="individual-sidebar__language-button is-active" type="button">English</button>
          <button class="individual-sidebar__language-button" type="button">Español</button>
        </div>
        <p class="individual-sidebar__legal">©2025 MemoraCare | Privacy Policy</p>
      </div>
    </aside>

    <main class="main-content individual-dashboard__main">
      <div class="main-card">
        <header class="main-card__header">
          <h1>Welcome back, <strong class="page-heading__highlight" data-user-name>Maria</strong></h1>
        </header>
        <div class="main-card__metrics">
          <div class="metric-item">
            <span class="metric-item__label">Your Plan Status</span>
            <span class="status-pill status-pill--active">ACTIVE</span>
          </div>
          <div class="metric-item">
            <span class="metric-item__label">Your Coverage</span>
            <span class="status-pill status-pill--coverage">UP TO $15,000</span>
          </div>
          <div class="metric-item">
            <span class="metric-item__label">Next Payment</span>
            <span class="status-pill status-pill--payment">$48.99 DUE SEP 12, 2025</span>
          </div>
        </div>
        <div class="main-card__actions">
          <button class="individuals-action">Update My Profile</button>
          <button class="individuals-action">Manage My Plan</button>
          <button class="individuals-action">Add a Family Member</button>
          <button class="individuals-action">Manage Alerts</button>
        </div>
      </div>

      <section class="individual-banner">
        <div class="individual-banner__content">
          <h2>Human-centered benefits for your team.</h2>
          <p>Offer your employees reliable and affordable funeral protection. A practical solution to enhance your company's benefit offering and support your team when they need it most.</p>
        </div>
        <div class="banner-nav">
          <button class="banner-nav__arrow" aria-label="Previous">←</button>
          <button class="banner-nav__arrow" aria-label="Next">→</button>
        </div>
      </section>
    </main>
  </div>

  <script src="i18n.js"></script>
  <script src="app.js"></script>
  <script>
    const API_USER_ME = 'https://memoracare.org/wp-json/wp/v2/users/me';

    function loadCurrentUser() {
      const token = localStorage.getItem('token');

      if (!token) {
        console.warn('No token found');
        return;
      }

      fetch(API_USER_ME, {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      })
        .then(res => {
          if (!res.ok) throw new Error('Error: ' + res.status);
          return res.json();
        })
        .then(user => {
          const fullName = user.name || '';
          const nameEl = document.querySelector('#sidebarUserName');
          if (nameEl) nameEl.textContent = fullName;
        })
        .catch(err => console.error(err));
    }

    document.addEventListener('DOMContentLoaded', loadCurrentUser);
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const API_BASE = 'https://memoracare.org/wp-json';
      const $ = (s, c = document) => c.querySelector(s);
      const $$ = (s, c = document) => Array.from(c.querySelectorAll(s));

      function titleCaseEmail(email) {
        if (!email) return 'Usuario';
        const base = email.split('@')[0].replace(/[._-]+/g, ' ');
        return base.split(' ').map(w => w ? w[0].toUpperCase() + w.slice(1) : '').join(' ');
      }

      const token = sessionStorage.getItem('memora_token');
      if (!token) { console.warn('[Memora] no hay token, voy a login'); location.href = '/login.html'; return; }

      let me = null;
      try { me = JSON.parse(sessionStorage.getItem('memora_user') || 'null'); } catch (_) { }
      try {
        const r = await fetch(`${API_BASE}/memora/v1/me`, { headers: { Authorization: 'Bearer ' + token } });
        if (r.ok) { me = await r.json(); sessionStorage.setItem('memora_user', JSON.stringify(me)); }
        else if (!me) { throw new Error('No autenticado'); }
      } catch (e) {
        console.warn('[Memora] no pude traer /me', e);
        if (!me) { location.href = '/login.html'; return; }
      }

      const displayName = me.display || me.name || titleCaseEmail(me.email);
      const nameTargets = ['[data-user-name]', '.individual-dashboard__profile-name', '.profile-name', '#user-name', '.user-name'];
      for (const sel of nameTargets) { $$(sel).forEach(el => { el.textContent = displayName; }); }

      const logoutBtn = document.querySelector('.logout');
      if (logoutBtn) logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('memora_token');
        sessionStorage.removeItem('memora_user');
        location.href = '/login.html';
      });
    });
  </script>
</body>
</html>
