<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Individual</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>

<script>
(function(){
  const API_BASE = 'https://memoracare.org/wp-json';

  // Utilidades
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

  function titleCaseEmail(email){
    if(!email) return 'Usuario';
    const base = email.split('@')[0].replace(/[._-]+/g,' ');
    return base.split(' ').map(w=>w? w[0].toUpperCase()+w.slice(1) : '').join(' ');
  }
  function formatDateISO(iso){
    if(!iso) return '-';
    const d = new Date(iso);
    if(isNaN(d)) return '-';
    return d.toLocaleDateString('es-AR',{day:'2-digit',month:'short',year:'numeric'}).replace('.', '');
  }

  // Mapeos de plan/estado a textos del dashboard
  function planToUI(me){
    const plan = (me?.plan||'').toLowerCase();
    if (plan === 'bussines' || plan === 'business' || plan === 'corporate') {
      return { badge: 'Miembro empresarial', planName: 'Corporate', redirect: '/business-dashboard.html' };
    }
    if (plan === 'familiar' || plan === 'personal' || plan === 'individual') {
      return { badge: 'Miembro individual', planName: 'Individual / Familiar', redirect: '/individual-dashboard.html' };
    }
    return { badge: 'Sin membresía', planName: '—', redirect: '/' };
  }
  function statusToUI(status){
    const s = (status||'').toLowerCase();
    if (s === 'active' || s === 'wc-active') return { label: 'Activo', classSuccess: true };
    if (s === 'on-hold' || s === 'pending') return { label: 'En pausa', classSuccess: false };
    if (s === 'cancelled' || s === 'expired') return { label: 'Inactivo', classSuccess: false };
    return { label: 'Desconocido', classSuccess: false };
  }

  async function hydrate(){
    const token = sessionStorage.getItem('memora_token');
    if (!token) {
      // sin sesión → volver al login
      window.location.href = '/login.html';
      return;
    }

    // Intentamos leer del cache guardado por el login para mostrar algo rápido
    let me = null;
    try { me = JSON.parse(sessionStorage.getItem('memora_user') || 'null'); } catch(_){}

    // Refrescamos desde el backend para asegurar estado al día
    try{
      const r = await fetch(`${API_BASE}/memora/v1/me`, { headers:{ Authorization: 'Bearer '+token }});
      if (r.ok) { me = await r.json(); sessionStorage.setItem('memora_user', JSON.stringify(me)); }
      else if (!me) { throw new Error('No autenticado'); }
    }catch(e){
      console.warn('No se pudo refrescar /me:', e);
      if (!me) { window.location.href = '/login.html'; return; }
    }

    // Nombre a mostrar
    const displayName = me.display || me.name || titleCaseEmail(me.email);
    $$('[data-user-name]').forEach(el => el.textContent = displayName);

    // Avatar (si en el futuro lo guardás en user meta)
    $$('[data-user-avatar]').forEach(el => {
      // Si algún día tienes me.avatar, ponelo acá:
      // if (me.avatar) el.src = me.avatar;
    });

    // Plan y estado
    const planUI = planToUI(me);
    const statusUI = statusToUI(me.status);

    // Sidebar: “Miembro individual/empresarial”
    const eyebrow = $('.individual-dashboard__profile-eyebrow');
    if (eyebrow) eyebrow.textContent = planUI.badge;

    // Tarjeta de plan: nombre y estado
    const planNameEl = $('.individual-dashboard__plan-name');
    if (planNameEl) planNameEl.textContent = planUI.planName;

    const planStatusEl = $('.individual-dashboard__plan-status');
    if (planStatusEl) planStatusEl.textContent = statusUI.label;

    // Métricas de estado (badge verde o no)
    const metricStatus = $('.metric-card .metric-card__value');
    if (metricStatus && statusUI.classSuccess) {
      metricStatus.classList.add('metric-card__value--success');
      metricStatus.textContent = 'Activo';
    } else if (metricStatus) {
      metricStatus.classList.remove('metric-card__value--success');
      metricStatus.textContent = statusUI.label;
    }

    // Próximo pago / vencimiento (si tu endpoint expone expires_at)
    const nextPayEls = $$('.individual-dashboard .metric-card:nth-child(3) .metric-card__value, .individual-dashboard__plan-list dd:nth-of-type(2)');
    nextPayEls.forEach(el => el.textContent = formatDateISO(me.expires_at));

    // Logout
    const logoutBtn = $('.logout');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('memora_token');
        sessionStorage.removeItem('memora_user');
        window.location.href = '/login.html';
      });
    }
  }

  hydrate();
})();
</script>

<body>
  <div class="individual-dashboard">
    <aside class="individual-dashboard__sidebar">
      <div class="individual-dashboard__brand">
        <img src="images/imagen blanca.png" alt="Wellbeing logo" class="individual-dashboard__logo">
      </div>
      <div class="individual-dashboard__profile-card">
        <div class="individual-dashboard__profile-avatar">
          <img src="images/avatar-default.svg" alt="Avatar del usuario" class="individual-dashboard__profile-avatar-image" data-user-avatar>
        </div>
        <div class="individual-dashboard__profile-text">
          <p class="individual-dashboard__profile-eyebrow">Miembro individual</p>
          <h2 class="individual-dashboard__profile-name"><span data-user-name>Maria Thompson</span></h2>
          <p class="individual-dashboard__profile-meta">Miembro desde marzo 2023</p>
        </div>
      </div>
      <div class="individual-dashboard__plan-card">
        <header class="individual-dashboard__plan-header">
          <span class="individual-dashboard__plan-label">Plan actual</span>
          <span class="individual-dashboard__plan-status">Activo</span>
        </header>
        <h3 class="individual-dashboard__plan-name">Family Protect Plus</h3>
        <p class="individual-dashboard__plan-meta">Salud • Visión • Dental</p>
        <dl class="individual-dashboard__plan-list">
          <div>
            <dt>Cobertura</dt>
            <dd>Hasta $100,000</dd>
          </div>
          <div>
            <dt>Próximo pago</dt>
            <dd>15 Oct 2025</dd>
          </div>
        </dl>
        <button class="button ghost-button">Ver detalles</button>
      </div>
      <nav class="individual-dashboard__menu">
        <a class="active" href="individual-dashboard.html">Inicio</a>
        <a href="my-profile.html">Mi perfil</a>
        <a href="manage-my-plan.html">Mi plan</a>
        <a href="payments.html">Pagos</a>
        <a href="settings.html">Ajustes</a>
      </nav>
      <div class="individual-dashboard__sidebar-footer">
        <button class="button outline-button logout">Cerrar sesión</button>
      </div>
    </aside>
    <main class="individual-dashboard__main">
      <header class="individual-hero">
        <div class="individual-hero__info">
          <div class="individual-hero__avatar">
            <img src="images/avatar-default.svg" alt="Avatar del usuario" class="individual-hero__avatar-image" data-user-avatar>
          </div>
          <div class="individual-hero__copy">
            <p class="individual-hero__eyebrow">Bienvenida de nuevo</p>
            <h1 class="individual-hero__title"><span data-user-name>Maria Thompson</span></h1>
            <p class="individual-hero__subtitle">Tu plan Family Protect Plus está activo y cubre atención médica, visión y dental para toda tu familia.</p>
          </div>
        </div>
        <div class="individual-hero__actions">
          <button class="button solid-button">Gestionar mi plan</button>
          <button class="button ghost-button">Actualizar mis datos</button>
        </div>
      </header>
      <section class="individual-metrics">
        <article class="metric-card">
          <span class="metric-card__label">Estado del plan</span>
          <span class="metric-card__value metric-card__value--success">Activo</span>
          <p class="metric-card__meta">Renovado el 18 de abril de 2025</p>
        </article>
        <article class="metric-card">
          <span class="metric-card__label">Cobertura disponible</span>
          <span class="metric-card__value">$100,000</span>
          <p class="metric-card__meta">Incluye servicios de salud, visión y dental</p>
        </article>
        <article class="metric-card">
          <span class="metric-card__label">Próximo pago</span>
          <span class="metric-card__value">15 Oct 2025</span>
          <p class="metric-card__meta">Cargo automático programado</p>
        </article>
      </section>
      <section class="individual-content">
        <article class="panel">
          <header class="panel__header">
            <h2 class="panel__title">Tareas rápidas</h2>
            <p class="panel__subtitle">Completa estas acciones sugeridas para mantener tu plan al día.</p>
          </header>
          <ul class="tasks-list">
            <li class="tasks-list__item">
              <span class="tasks-list__badge">1</span>
              <div class="tasks-list__content">
                <h3>Agregar beneficiario secundario</h3>
                <p>Agrega un contacto alternativo para acelerar cualquier reclamo.</p>
              </div>
              <button class="button outline-button">Agregar</button>
            </li>
            <li class="tasks-list__item">
              <span class="tasks-list__badge">2</span>
              <div class="tasks-list__content">
                <h3>Subir comprobante de residencia</h3>
                <p>Verifica que tu dirección esté actualizada para recibir correspondencia.</p>
              </div>
              <button class="button outline-button">Subir</button>
            </li>
            <li class="tasks-list__item">
              <span class="tasks-list__badge">3</span>
              <div class="tasks-list__content">
                <h3>Configurar alertas de pago</h3>
                <p>Recibe recordatorios por correo o SMS antes de cada vencimiento.</p>
              </div>
              <button class="button outline-button">Configurar</button>
            </li>
          </ul>
        </article>
        <article class="panel">
          <header class="panel__header">
            <h2 class="panel__title">Beneficiarios</h2>
            <p class="panel__subtitle">Gestiona quién recibirá tu cobertura si la necesitas.</p>
          </header>
          <div class="beneficiary-card">
            <h3 class="beneficiary-card__name">Andrés Rodriguez</h3>
            <p class="beneficiary-card__relation">Cónyuge • 100% asignado</p>
            <p class="beneficiary-card__contact">+1 (312) 555-3421 • andres.rodriguez@email.com</p>
            <div class="beneficiary-card__actions">
              <button class="button ghost-button">Actualizar datos</button>
              <button class="button outline-button">Cambiar porcentaje</button>
            </div>
          </div>
        </article>
        <article class="panel panel--documents">
          <header class="panel__header">
            <h2 class="panel__title">Documentos de identidad</h2>
            <p class="panel__subtitle">Tu verificación está casi completa, solo falta un documento.</p>
          </header>
          <ul class="documents-status">
            <li class="documents-status__item">
              <div class="documents-status__info">
                <h3>Pasaporte</h3>
                <p>Subido el 2 de abril de 2025</p>
              </div>
              <span class="status-pill status-pill--success">Aprobado</span>
              <button class="button ghost-button">Reemplazar</button>
            </li>
            <li class="documents-status__item">
              <div class="documents-status__info">
                <h3>Licencia de conducir</h3>
                <p>Vence el 14 de agosto de 2025</p>
              </div>
              <span class="status-pill status-pill--warning">Por vencer</span>
              <button class="button ghost-button">Actualizar</button>
            </li>
            <li class="documents-status__item">
              <div class="documents-status__info">
                <h3>Tarjeta de seguro social</h3>
                <p>No se ha cargado ningún archivo</p>
              </div>
              <span class="status-pill status-pill--neutral">Pendiente</span>
              <button class="button ghost-button">Subir</button>
            </li>
          </ul>
        </article>
        <article class="panel panel--wide">
          <header class="panel__header">
            <h2 class="panel__title">Soporte y próximos pasos</h2>
            <p class="panel__subtitle">Tu equipo de cuidado está disponible para ayudarte cuando lo necesites.</p>
          </header>
          <div class="support-grid">
            <div class="support-grid__item">
              <h3>Agenda una llamada</h3>
              <p>Coordina una reunión virtual con un especialista de bienestar familiar.</p>
              <button class="button solid-button">Reservar</button>
            </div>
            <div class="support-grid__item">
              <h3>Mensajes seguros</h3>
              <p>Revisa la bandeja de entrada para responder a tu enfermera de cabecera.</p>
              <button class="button outline-button">Ir a mensajes</button>
            </div>
            <div class="support-grid__item">
              <h3>Centro de ayuda</h3>
              <p>Encuentra guías y preguntas frecuentes sobre coberturas y reembolsos.</p>
              <button class="button ghost-button">Ver artículos</button>
            </div>
          </div>
        </article>
      </section>
    </main>
  </div>
  <script src="i18n.js"></script>
  <script src="app.js"></script>
</body>
</html>

<script src="i18n.js"></script>
<script src="app.js"></script>
